---
layout: single
title: "go lint æ—¶çš„ fieldalignment æ˜¯ä»€ä¹ˆ"
date: 2023-10-27T05:00:00+08:00
last_modified_at: 2023-10-27T12:00:00+08:00
author: hedzr
tags: [golang, lint]
categories: golang lint
comments: true
toc: true
header:
  teaser: /images/blog/image-20231026110402900.png
  overlay_image: /images/unsplash-image-3.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  ä¸“é—¨è°ˆè®º fieldalignment è­¦å‘ŠåŠå…¶è§£å†³æ–¹æ³• ...
---

Golang å¼€å‘æ—¶ï¼Œæœ‰æ—¶å€™çœ‹åˆ° fieldalignment è­¦å‘Šï¼Œé‚£ä¹ˆå®ƒä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼Œå¦‚ä½•è§£å†³å‘¢ã€‚

## About fieldalignment

### ç»“æ„ä½“çš„ align ä¼˜åŒ–

ç»“æ„ä½“ä¸­çš„æˆå‘˜çš„å¯¹é½ä¼˜åŒ–ï¼Œæ˜¯ lint ä¸­ä¸€ä¸ªå«æ··çš„ææ³•ã€‚åˆå­¦è€…å°¤å…¶æ˜¯ C++ ç¨‹åºå‘˜ä¼šå¯¹æ­¤è¿·æƒ‘ï¼Œå› ä¸º string å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡é’ˆåœ¨ç»“æ„ä½“ä¸­å½“ç„¶æ˜¯å­—é•¿å¯¹é½çš„å‘€ã€‚

```go
type MyStruct struct { //nolint:govet //can be reordered
	id       uint64
	required string
	note     *string
}

```

è¿™ä¸ªç»“æ„ä½“ï¼ˆå»æ‰ nolint å®£å‘Šåï¼‰ä¼šå¾—åˆ° golangci-lint govet filedalignment çš„æŠ¥å‘Šï¼š

```
fieldalignment: struct with 32 pointer bytes could be 16 (govet)
```

å®é™…ä¸Šå‘¢ï¼Œfieldalignment è¿™ä¸ªå®¶ä¼™å¹¶ä¸æ˜¯çœŸçš„åœ¨åˆ†æç»“æ„ä½“çš„æˆå‘˜å˜é‡æ˜¯ä¸æ˜¯æœ‰æ•ˆåœ°å­—é•¿å¯¹é½äº†ã€‚å®ƒåšçš„äº‹æ˜¯ç ”ç©¶æˆå‘˜å˜é‡çš„æ’åˆ—é¡ºåºæ˜¯å¦æœ‰åˆ©äº GC æ‰«æä¾èµ–å…³ç³»ã€‚

æ‰€ä»¥è§£å†³çš„æ–¹æ³•å°±å¾ˆæ¸…æ¥šäº†ï¼Œå°†å¸¦æœ‰æŒ‡é’ˆçš„å­—æ®µå°½é‡æå‰ï¼Œéšå¼æŒ‡é’ˆçš„ç±»å‹ï¼ˆä¾‹å¦‚ stringï¼Œsliceï¼Œarrayï¼Œmap ç­‰ï¼‰ä¹Ÿå¦‚æ­¤ï¼Œé‚£ä¹ˆ GC åªéœ€è¦æ‰«æç»“æ„ä½“çš„å‰é¢è‹¥å¹²å­—èŠ‚å°±èƒ½åˆ¤æ–­ä¾èµ–å…³ç³»äº†ã€‚

ç›¸ååœ°ï¼Œå¦‚æœé¦–å…ˆæ‘†æ”¾å åœ°é¢ç§¯å¾ˆå¤§çš„å­—æ®µï¼Œé‚£ä¹ˆ GC å¯èƒ½ä¸å¾—ä¸éœ€è¦å…ˆéå†è¿™å—ç©ºé—´åæ‰èƒ½å‘ç° b æ˜¯éœ€è¦ç™»è®°ä¸€ä¸ªå¼•ç”¨è®¡æ•°çš„ï¼š

```go
// GC will scan all 808 bytes.
type gcNotOptimized struct {
  a [100]int64
  b *int64
}
```

æ‰€ä»¥å®ƒçš„æ”¹è¿›åº”è¯¥æ˜¯ï¼š

```go
// GC will scan only 8 bytes.
type gcNotOptimized struct {
  b *int64
  a [100]int64
}
```

> ä¸¥æ ¼åœ°è¯´ï¼ŒGC çš„ç¡®ä¸å–œæ¬¢ [100]int64 è¿™æ ·çš„ä¸œè¥¿ï¼Œè¿™æ›´æ˜¯å› ä¸ºå•ä¸ªç»“æ„ä½“å æ®ç©ºé—´å¤ªå¤§äº†ï¼Œè¿™æ ·çš„ä»£ç åº”è¯¥ä»è®¾è®¡ä¸Šæ‹†åˆ†ï¼Œä½¿ç”¨å°å·§çš„ç»“æ„ä½“æ‰æ˜¯è¢«æ¨èçš„ã€‚
>
> å½“ç„¶è¿™ä¸ªä¾‹å­çº¯å±æ•…æ„ï¼Œä»…ä½œç¤ºæ„ï¼Œä¸å¤Ÿä¸¥è°¨ä¹‹å¤„å°±ç®—äº†ã€‚

è€Œå‰é¢çš„ä¾‹å­ MyStruct åº”è¯¥æ”¹å†™ä¸ºï¼š

```go
type MyStruct struct {
	note     *string  // æŒ‡é’ˆä¼˜å…ˆ
	required string   // éšå¼æŒ‡é’ˆæ¬¡ä¹‹
	id       uint64
}
```

å…³äº fieldalignment è¿˜æœ‰ä¸€äº›å¯ä»¥è®¨è®ºçš„ï¼Œæ‰€ä»¥ä¸‹æ¬¡å•ç‹¬ä¸€ç¯‡èŠä¸€èŠå§ã€‚å‘ï¼Œç°åœ¨å°±æ˜¯ä¸‹ä¸€æ¬¡äº†ã€‚

### ä»¥ä¸Šéƒ½æ˜¯ä¸Šç¯‡æ–‡ç« ä¸­è¯´è¿‡çš„

ä¸‹é¢æ‰æ˜¯æ–°çš„ã€‚

### å­—æ®µæ‘†æ”¾åŸåˆ™

ç”±äºæ ¸å¿ƒè¦ç´ åœ¨äºè®© GC æ‰«æå™¨é’ˆå¯¹ struct ä»å¤´å¼€å§‹æ‰«æå­—æ®µæ—¶å°½å¯èƒ½å°‘éå†å†…å­˜å—ï¼Œé‚£å°±è¦å°†æŒ‡é’ˆå‹å­—æ®µå°½å¯èƒ½å‰ç½®ï¼Œæ–¹ä¾¿æ‰«æå™¨åªè¦æ£€è§†è¿™éƒ¨åˆ†å­—æ®µå°±å¯ä»¥äº†ï¼Œç„¶åå åœ°é¢ç§¯å°‘çš„å°å­—æ®µå°½å¯èƒ½é å‰ï¼Œè®©æ‰«æå™¨å¿…é¡»æ£€è§†çš„å†…å­˜å—çš„ Size ä¹Ÿè¶³å¤Ÿå°ã€‚

ä¸è¿‡å®é™…ä¸Š fieldalignment çš„æºç æ­ç¤ºçš„è§„åˆ™ç›¸å½“å¤æ‚ï¼Œå¾ˆéš¾å¯¹å…¶è¿›è¡Œç®€åŒ–å’Œå½’çº³ã€‚

æ‰€ä»¥æˆ‘ä»¬åªèƒ½é‡‡ç”¨æ¯”è¾ƒç¬¨çš„åŠæ³•ï¼Œç½—åˆ—å‡ºå¦‚ä¸‹çš„é¡ºåºåŸåˆ™ä¾›å‚è€ƒï¼š

1. map æœ€ä¼˜å…ˆ, key å’Œ value çš„ç±»å‹æ— å…³ç´§è¦ã€‚
2. æŒ‡é’ˆå­—æ®µæ¬¡ä¼˜å…ˆã€‚é€šå¸¸æŒ‡å‘çš„ç±»å‹æ— å…³ç´§è¦ã€‚
3. éšå¼æŒ‡é’ˆï¼Œå½¼æ­¤å¯ä»¥äº’ç›¸æ··æ’

   1. arrayï¼ˆä½†ä¸åŒ…æ‹¬ byte arrayï¼‰
   2. sliceï¼ˆä¹ŸåŒ…æ‹¬ byte sliceï¼‰
   3. string
   4. åµŒå…¥ç»“æ„åŠå…¶ array å’Œ slice

4. primitives

   1. int, uint, float, complex ç­‰çš„å½¼æ­¤é¡ºåºæ— å…³ç´§è¦
   2. åŸåˆ™ä¸Šå¯ä»¥ä¸éšå¼æŒ‡é’ˆæ··æ’

5. byte array
6. int8/byte æ¬¡ä¹‹
7. bool æœ€å
8. ç‰¹åˆ«æ¡ˆä¾‹
   1. ç©ºç»“æ„ `struct{}` åœ¨è¯­è¨€è§„èŒƒå±‚é¢è¢«è®¾è®¡ä¸º 0 å­—èŠ‚å ç”¨ï¼Œè€Œä¸æ˜¯åƒç»“æ„é‚£æ ·è¢«å½“ä½œéšå¼æŒ‡é’ˆã€‚å®ƒéœ€è¦è¢«ç½®äºç»“æ„ä½“æœ€å‰ç«¯ã€‚
   1. å…¶åæ‰æ˜¯ mapï¼Œpointer

æ€»çš„æ¥è¯´ï¼Œå­—æ®µæ‘†æ”¾å’Œ C++ æƒ¯ä¾‹ä¸Šçš„å­—é•¿å¯¹é½æ˜¯ä¸€ç‚¹å…³ç³»ä¹Ÿæ²¡æœ‰çš„ã€‚è€Œä¸”æ‰€è°“çš„ä¸åˆæ ¼çš„é¡ºåºï¼Œå…¶å®å’Œå¯¹é½ä¹‹åèŠ‚çº¦ç©ºé—´ä¹Ÿæ˜¯ä¸€ç‚¹å…³ç³»éƒ½æœ¨æœ‰ã€‚

å¦å¤–ï¼ŒC++ ç¨‹åºå‘˜å¾€å¾€ä¹ æƒ¯äºå°†å­—æ®µæŒ‰ç…§å°çš„åŠŸèƒ½ç»„æ¥åˆ†ç»„æ’åˆ—ï¼Œä½†è¿™æ˜¯æ²¡æ„ä¹‰çš„ï¼Œå› ä¸ºé¡ºåºé¦–å…ˆéœ€è¦å±ˆæœäº GC çš„å–œå¥½ã€‚æ‰€ä»¥åœ¨ Golang é‡Œé¢å¼ºè¿«ç—‡æ‚£è€…éƒ½å¾—æ­»ï¼Œå¾ˆå¯æ‚²ã€‚

ä¸‹é¢æ˜¯ä¸åˆé€‚ç¤ºä¾‹åŠå…¶è§£å†³ï¼š

```go
type MyStruct struct { //nolint:govet //can be reordered
	id       uint64
	required string
	note     *string
}

type testCase struct { //nolint:govet //can be reordered
	given  float64
	expect string
}
```

æ”¹æ­£åçš„å†™æ³•å¦‚ä¸‹ï¼š

```go
type MyStruct struct {
	note     *string
	required string
	id       uint64
}

type testCase struct {
	expect string
	given  float64
}
```

### è‡ªåŠ¨æ›´æ­£

å®é™…ä¸Šä¹Ÿæœ‰ä¸€ä¸ªå·¥å…·å¯ä»¥è‡ªåŠ¨æ›´æ­£ä½ çš„ä»£ç ä¸­çš„è¿™äº›é—®é¢˜ã€‚

å¯ä»¥ç¼–è¯‘å’Œå®‰è£…è¿™ä¸ªå·¥å…·ï¼š

```bash
go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@latest
```

ç„¶åä½ è‚¯å®šå·²ç»å°† `~/go/bin` åŠ å…¥åˆ°ç¯å¢ƒå˜é‡ `PATH` ä¹‹ä¸­äº†ã€‚æ‰€ä»¥ï¼š

```bash
fieldalignment -fix <package_path>
```

å°±èƒ½å¤Ÿè‡ªåŠ¨è§£å†³é—®é¢˜äº†ã€‚æ‰€æœ‰çš„ç»“æ„ä½“éƒ½ä¼šè¢«é‡æ–°æ‘†å¸ƒä¸€éï¼Œä¾æ®å‰é¢æˆ‘ä»¬æ‰€æåˆ°è¿‡çš„é‚£äº›åŸºæœ¬å‡†åˆ™ã€‚

ç„¶åï¼Œè¿™ä¸ªå·¥å…·ä¹Ÿæœ‰ä¸€ä¸ªå…³é”®çš„çŸ­æ¿ï¼Œè®©äººæ¬²ç½¢ä¸èƒ½ï¼šå®ƒä¼šåœ¨é‡æ–°æ’å¸ƒç»“æ„ä½“æˆå‘˜çš„æ—¶å€™ï¼Œå°†æ‰€æœ‰ç©ºè¡Œã€æ³¨é‡Šé€šé€šåˆ å»ã€‚

è¿™å°±è¦äº†è€å‘½äº†ã€‚

æ‰€ä»¥æœ‰æ—¶å€™ï¼Œä½ åº”è¯¥ git commit ä¸€æ¬¡ï¼Œç„¶åç”¨ä¸€ä¸‹è¿™ä¸ªå·¥å…·ï¼Œç„¶åé€šè¿‡ git diff æ¥ review å®ƒæ‰€åšçš„å˜æ›´ï¼Œç„¶åè¿›è¡Œè‹¥å¹²åå¤„ç†ã€‚

æ›´å¥½çš„åŠæ³•æ˜¯ï¼Œå‚è€ƒå‰æ–‡æ‰€å™è¿°çš„åŸåˆ™ä¸Šçš„é¡ºåºï¼Œä½ å¯ä»¥è‡ªè¡Œæ‰‹å·¥æ’å¸ƒï¼Œåœ¨ç¼–ç çš„æ—¶å€™ç›´æ¥å°±æ¶ˆé™¤ä¸€åˆ‡ç›¸å…³è­¦å‘Šã€‚é‚£å°±ä¸ä¼šæœ‰é—®é¢˜äº†ã€‚

### åœ¨ golangci-lint ä¸­ä½¿ç”¨

è‡ªä»ä»æŸäººé‚£è¾¹äº†è§£åˆ° golangci-lint ä¹‹åï¼Œæˆ‘å°±å†ä¹Ÿæ²¡ç”¨è¿‡ go lint äº†ã€‚å¿…é¡»æ‰¿è®¤ golangci-lint çš„å¯ç”¨æ€§è¦ä¼˜ç§€çš„å¤šã€‚å½“ç„¶æœ‰æ—¶å€™ï¼ˆç‰¹åˆ«æ˜¯é¡¹ç›®è¶³å¤Ÿå¤§æ—¶ï¼‰å®ƒå ç”¨çš„ CPU ä¹Ÿå¤ªé«˜äº†ï¼Œä»¥è‡³äºæœ‰æ—¶å€™å¿…é¡»å¯¹å…¶è¿›è¡Œé™åˆ¶ã€‚

åœ¨ Golang Project çš„æ ¹ç›®å½•æ”¾ä¸€ä¸ª .gilangci.yaml å°±èƒ½åœ¨æ•´ä¸ªé¡¹ç›®ä¸­åº”ç”¨å…¶ä¸­ä½¿èƒ½çš„ validdatorsã€‚

fieldalignment æ˜¯éš¶å±äº govet çš„ä¸€ä¸ªå­åŠŸèƒ½ï¼Œåœ¨ .golangci.yaml ä¸­å¯ä»¥è¿™æ ·å¯ç”¨å®ƒï¼š

```yaml
linters:
  disable-all: true
  enable:
    - govet
  fast: false

linters-settings:
  govet:
    # report about shadowed variables
    check-shadowing: false
    fast: false
    # disable:
    #  - fieldalignment # I'm ok to waste some bytes
    enable:
      - fieldalignment
```

åä¹‹å°±å–æ¶ˆ disable æ³¨é‡Šç„¶åå»æ‰ enable å­å¥ã€‚

### èƒŒå

å¦‚æœæ„Ÿå…´è¶£å®˜æ–¹æ˜¯æ€ä¹ˆåšçš„ï¼Œå¯ä»¥ç ”ç©¶æºç ï¼š

`fieldalignment` code https://cs.opensource.google/go/x/tools/+/refs/tags/v0.1.7:go/analysis/passes/fieldalignment/fieldalignment.go

golang çš„æºç ä¹Ÿå¯ä»¥è¯»è¯»ï¼Œå¯ä»¥ä»è¿™é‡Œå¼€å§‹ï¼š

https://github.com/golang/go/blob/master/src/runtime/mgcmark.go

ä¸€èˆ¬æ¥è¯´æˆ‘å¹¶ä¸æ¨èã€‚

è¶…å¤§å‹é¡¹ç›®ä¸æ˜¯é‚£ä¹ˆå¥½è¯»çš„ï¼Œä¹Ÿä¸ä¸€å®šæœ‰ç”¨å¤„ã€‚ç‰¹åˆ«æ˜¯é‡åˆ°æ´»è·ƒçš„é¡¹ç›®éƒ½æ´»è·ƒçš„éƒ¨ä½æ—¶æ›´æ˜¯å¾ˆä¸å€¼å¾—ã€‚

## åè®°

æ”¾é£è‡ªæˆ‘æ—¶é—´åˆ°ï¼

æˆ‘è¿™æ¬¡å¾ˆæ²‰ç¨³ï¼Œå•¥ä¹Ÿä¸è¯´ã€‚

### REFs

ç¨å¾®åˆ—å‡ºä¸€ç‚¹ï¼Œ

- [Structure size optimization in Golang (alignment/padding). More effective memory layout (linters). - by Roman Romadin - ITNEXT](https://itnext.io/structure-size-optimization-in-golang-alignment-padding-more-effective-memory-layout-linters-fffdcba27c61)
- [Can you help me understand "fieldalignment: struct with 40 pointer bytes could be 8" ? Â· golangci/golangci-lint Â· Discussion #2298](https://github.com/golangci/golangci-lint/discussions/2298)

æ›´å¤šçš„è‡ªå·±æœå§

### ç”³æ˜

æœ¬æ–‡è®ºåŠçš„æ’åˆ—é¡ºåºï¼Œçº¯å±ä¸ªäººç†è§£ï¼Œå¹¶æœªå¾—åˆ°ç›¸å…³å®˜æ–¹è®¤å¯ã€‚

å‚è€ƒæœ¬æ–‡æ‰€å¼•èµ·çš„åæœè¾„éä½œè€…æ‰€æ§ã€‚

å¦‚æœ‰å¿…è¦ï¼Œè¯·ä»¥ `fieldalignment -fix` çš„ç»“è®ºä¸ºå‡†ã€‚

ğŸ”š
